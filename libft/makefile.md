Makefileの基本ルール

ターゲット(target)... : 依存ファイル（prerequisite） ...
	レシピ(recipe)
	...
	...

ターゲットとは実行ファイルやオブジェクトファイルなどのプログラムによって作成されるファイルのこと。cleanのような、実行するアクションの名前になることもある。

依存ファイルはターゲットを作成するための入力ファイル、通常ターゲットは複数の依存ファイルに依存する。

レシピはmakeが実行するアクションのこと。複数のコマンドをまとめることができる。レシピの各行の先頭には必ずタブ文字(tab)がなければならない。レシピとはターゲットファイルをどのように更新するかを記述したものである。

例）

test : main .o  ft_printf.o
	cc -o test main.o ft_printf.o

main.o : main.c defs.h
	cc -c main.c

ft_printf.o : ft_printf.c libft.h
	cc -c ft_printf.c

clean :
        rm test main.o ft_printf.o


例のように\と改行を用いて二行に分割することができ、実際には長い一行として扱われる。
このMakefileを用いてeditという実行ファイルを作成するには次のコマンドを入力する。

make

このmakefileを使ってディレクトリ内の実行ファイルとすべてのオブジェクトファイルを削除するには次にコマンドを入力する。

make clean

cleanターゲットはファイルではなく、単なるアクションの名前であり、通常このルールのアクションは明示的に指示されない限りは実行されず、自動的には実行されない。

makeがMakefileを処理する方法

makeはカレントディレクトリからMakefileを呼び込み、デフォルトでは最初のターゲットから処理をはじめる（例1の場合だとtest）。これをデフォルトゴール(default goal)と呼ぶ。それに伴って、デフォルトゴールのターゲットファイルを作成するために必要な依存ファイルを処理する必要があるため、それぞれのオブジェクトファイルは、それぞれ専用のルールで処理される。
それらのファイルが更新されるのは以下のケースである。
　
1.ソースファイルや指定されているヘッダファイルのどれかが、オブジェクトファイルより新しい場合。
2.またはオブジェクトファイルが存在していない場合。

変数を使用する

例の場合全てのオブジェクトファイルを複数回記述する必要があるため、一般的には変数(variable)を使用する。慣習的にどのMakefileでもすべてのオブジェクトファイルのリストを以下のような名前でまとめるのが一般的である。

objests
OBJECTS
objs
OBJS
obj
OBJ

例えば今回のMakefileでは次のように変数objectsを定義する。

objects = main.o ft_printf.o

その後オブジェクトファイルのリストを使いたい場所では、$(objects)と書く。変数を使用した場合のMakefileは以下のようになる。
また、cleanを実行する際、claenという名前のファイルがディレクトリに存在する場合、makeが混乱してしまう。それを防ぐための安全な書き方として.PHONYが存在する。

例）

objects = main.o ft_printf.o

test : $(objects)
	cc -o test $(objects)

main.o : main.c defs.h
	cc -c main.c

ft_printf.o : ft_printf.c libft.h
	cc -c ft_printf.c
.PHONY : clean
clean :
        rm test $(objects)

Makefileには自動でセットされる特別な変数が存在する。以下がその代表的なものである。

$@　ルールのターゲット（左辺）の名前
$^　すべての依存ファイル（右辺）のリスト（重複なし）
$<　最初の依存ファイル

例）
main.o : main.c defs.h
	cc -c $<

シェルと同様に、ワイルドカード（特殊記号）を使用して、複数のファイルを一括で指定することができる。
使えるワイルドカードは以下である。

* : すべての文字列にマッチ
? : 任意の一文字にマッチ
[abc] : カッコ内のどれか一文字にマッチ

例）

clean :
	rm -f *.o
→すべての.oファイルを削除する。

ただし、変数の宣言にワイルドカードを使う際にはwildcard関数を使用する必要がある。
wildcard関数の書式は以下である。

$(wildcard パターン...)

例）
objects = $(wildcard *.o)
